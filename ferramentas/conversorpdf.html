<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Markdown → PDF</title>
  <style>
    /* Reset básico */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { display: flex; height: 100vh; font-family: sans-serif; }

    /* Sidebar */
    #sidebar {
      width: 250px; background: #2c3e50; color: white;
      display: flex; flex-direction: column;
    }
    #sidebar h2 { padding: 1rem; }
    #doc-list { flex: 1; overflow-y: auto; }
    .doc-item {
      padding: .5rem 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .doc-item:hover, .doc-item.active { background: #34495e; }
    .doc-item button { background: none; border: none; color: #e74c3c; cursor: pointer; }

    #new-doc-btn { margin: 1rem; padding: .5rem; background: #27ae60; border: none; color: white; cursor: pointer; border-radius: 4px; }

    /* Main */
    #main {
      flex: 1; display: flex; flex-direction: column; padding: 1rem;
    }
    #doc-name { font-size: 1.2rem; padding: .5rem; margin-bottom: .5rem; }
    #markdown-input { flex: 1; width: 100%; padding: .5rem; font-family: monospace; resize: none; }
    #controls { margin-top: .5rem; display: flex; gap: .5rem; flex-wrap: wrap; }
    #controls button {
      flex: 1; padding: .7rem; border: none; border-radius: 4px;
      cursor: pointer; font-weight: bold;
    }
    #save-btn { background: #2980b9; color: white; }
    #preview-btn { background: #f39c12; color: white; }
    #download-btn { background: #16a085; color: white; }

    /* Modal Preview */
    #preview-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center;
      overflow: auto; padding: 2rem;
    }
    #preview-content {
      background: white; padding: 1rem; border-radius: 8px;
      max-width: 95%; max-height: 95%; overflow: auto;
    }
    .pdf-page {
      width: 794px; height: 1123px; /* A4 @96dpi */
      margin: 1rem auto; padding: 40px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3); position: relative;
      background: white;
      page-break-after: always;
    }
    .page-label {
      position: absolute; top: 10px; right: 20px; font-size: .9rem; color: #555;
    }
    /* adapta para mobile: escala para caber */
    @media (max-width: 850px) {
      .pdf-page { transform: scale(0.6); transform-origin: top center; }
    }
    @media (max-width: 550px) {
      .pdf-page { transform: scale(0.45); }
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Meus Docs</h2>
    <div id="doc-list"></div>
    <button id="new-doc-btn">+ Novo Documento</button>
  </div>
  <div id="main">
    <input id="doc-name" placeholder="Nome do documento">
    <textarea id="markdown-input" placeholder="Cole seu Markdown aqui..."></textarea>
    <div id="controls">
      <button id="save-btn">Salvar</button>
      <button id="preview-btn">Visualizar PDF</button>
      <button id="download-btn">Baixar PDF</button>
    </div>
  </div>

  <!-- Modal de preview -->
  <div id="preview-modal">
    <div id="preview-content"></div>
  </div>

  <!-- Dependências -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script>
    // ===== Gestão de storage =====
    const STORAGE_KEY = 'markdownDocs';
    let docs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let currentId = null;

    const docListEl = document.getElementById('doc-list');
    const nameInput = document.getElementById('doc-name');
    const mdInput = document.getElementById('markdown-input');
    const saveBtn = document.getElementById('save-btn');
    const previewBtn = document.getElementById('preview-btn');
    const downloadBtn = document.getElementById('download-btn');
    const newDocBtn = document.getElementById('new-doc-btn');
    const previewModal = document.getElementById('preview-modal');
    const previewContent = document.getElementById('preview-content');

    function renderDocList() {
      docListEl.innerHTML = '';
      docs.forEach(doc => {
        const div = document.createElement('div');
        div.className = 'doc-item' + (doc.id === currentId ? ' active' : '');
        div.innerHTML = `<span>${doc.name}</span>
          <button title="Excluir" onclick="deleteDoc('${doc.id}')">✕</button>`;
        div.onclick = () => selectDoc(doc.id);
        docListEl.appendChild(div);
      });
    }

    function selectDoc(id) {
      currentId = id;
      const doc = docs.find(d=> d.id===id);
      nameInput.value = doc.name;
      mdInput.value = doc.markdown;
      renderDocList();
    }

    function saveCurrent() {
      const name = nameInput.value.trim() || 'Sem título';
      const markdown = mdInput.value;
      if (!currentId) {
        currentId = Date.now().toString();
        docs.push({ id: currentId, name, markdown });
      } else {
        const doc = docs.find(d=> d.id===currentId);
        doc.name = name; doc.markdown = markdown;
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
      renderDocList();
      alert('Documento salvo!');
    }

    function newDoc() {
      currentId = null;
      nameInput.value = '';
      mdInput.value = '';
      renderDocList();
    }

    function deleteDoc(id) {
      if (!confirm('Confirma exclusão?')) return;
      docs = docs.filter(d=> d.id!==id);
      if (id === currentId) newDoc();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
      renderDocList();
    }

    // ===== Preview & Download =====
    function generatePagesContainer() {
      // container temporário
      const container = document.createElement('div');
      container.style.background = '#eee'; // diferente do white
      // converter markdown em HTML
      const html = marked.parse(mdInput.value);
      // fragmentar em páginas
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      // criar páginas ao encher altura
      const pageHeight = 1123 - 80; // altura interna
      let page = createPage();
      container.appendChild(page);
      let cursor = 0;

      Array.from(wrapper.childNodes).forEach(node => {
        page.content.appendChild(node.cloneNode(true));
        // se ultrapassar:
        if (page.content.scrollHeight > pageHeight) {
          // remove último
          page.content.removeChild(page.content.lastChild);
          // nova página
          page = createPage();
          container.appendChild(page);
          page.content.appendChild(node.cloneNode(true));
        }
      });
      return container;
    }

    function createPage() {
      const page = document.createElement('div');
      page.className = 'pdf-page';
      const label = document.createElement('div');
      label.className = 'page-label';
      const idx = document.querySelectorAll('.pdf-page').length + 1;
      label.textContent = `Página ${idx}`;
      page.appendChild(label);
      const content = document.createElement('div');
      content.style.marginTop = '30px';
      page.content = content;
      page.appendChild(content);
      return page;
    }

    function showPreview() {
      previewContent.innerHTML = '';
      const pages = generatePagesContainer();
      previewContent.appendChild(pages);
      previewModal.style.display = 'flex';
    }

    function closePreview() {
      previewModal.style.display = 'none';
      previewContent.innerHTML = '';
    }

    function downloadPDF() {
      const pagesContainer = generatePagesContainer();
      // usar html2pdf: mesmas dimensões
      html2pdf().set({
        margin:       10,
        filename:     (nameInput.value.trim() || 'documento') + '.pdf',
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'pt', format: [794, 1123], orientation: 'portrait' }
      }).from(pagesContainer).save();
    }

    // ===== Eventos =====
    saveBtn.onclick = saveCurrent;
    newDocBtn.onclick = newDoc;
    previewBtn.onclick = showPreview;
    downloadBtn.onclick = downloadPDF;
    previewModal.onclick = e => { if(e.target===previewModal) closePreview(); };

    // inicialização
    renderDocList();
  </script>
</body>
</html>
