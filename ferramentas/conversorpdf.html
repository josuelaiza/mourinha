<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Markdown para PDF</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- Variáveis Globais e Reset --- */
        :root {
            --primary-color: #7c3aed;
            --secondary-color: #10b981;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --text-color: #1e293b;
            --muted-text-color: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
            /* Configurações do PDF (serão atualizadas via JS) */
            --pdf-font-size: 16px;
            --pdf-margin: 20mm;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* --- Estrutura Principal --- */
        header {
            text-align: center;
            padding: 2rem 1rem;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
        }
        header h1 { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); }
        header p { max-width: 600px; margin: 0.5rem auto 0; color: var(--muted-text-color); }

        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        footer { text-align: center; padding: 2rem 1rem; margin-top: 2rem; color: var(--muted-text-color); font-size: 0.9rem; }

        /* --- Painel de Edição e Controles --- */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            align-items: flex-start;
        }

        .editor-section { display: flex; flex-direction: column; min-height: 65vh; }
        
        #markdown-input {
            flex-grow: 1;
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: monospace;
            font-size: 1rem;
            background-color: var(--surface-color);
            resize: vertical;
            box-shadow: var(--shadow);
        }
        #markdown-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .controls-panel {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 2rem;
        }

        .control-group { margin-bottom: 2rem; }
        .control-group:last-child { margin-bottom: 0; }
        .control-group h3 { font-size: 1.1rem; margin-bottom: 1rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; }
        .control-group .btn-group { display: flex; flex-direction: column; gap: 0.75rem; }
        
        .config-item { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
        .config-item label { font-weight: 500; color: var(--muted-text-color); font-size: 0.9rem;}
        .config-item input { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.5rem;}
        
        /* --- Botões --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.75rem 1.5rem; border: none; border-radius: var(--border-radius);
            font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn svg { width: 18px; height: 18px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #6d28d9; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover { background-color: #059669; }
        .btn-tertiary { background-color: #334155; color: white; }
        .btn-tertiary:hover { background-color: #1e293b; }

        /* --- MODAL DE PRÉ-VISUALIZAÇÃO --- */
        #preview-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000; display: none;
        }

        #preview-modal {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 95%; max-width: 1200px;
            height: 90vh;
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            z-index: 1001;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: none; flex-direction: column;
        }
        #preview-modal.fullscreen {
            width: 100%; height: 100%; top: 0; left: 0; border-radius: 0; transform: none; max-width: 100%;
        }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color);
            background-color: var(--surface-color); flex-shrink: 0;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        .modal-header h4 { font-size: 1.2rem; color: var(--primary-color); margin-right: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .modal-actions { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
        .modal-actions button { background: none; border: none; cursor: pointer; padding: 0.5rem; line-height: 0; }
        .modal-actions button svg { width: 22px; height: 22px; color: var(--muted-text-color); }
        .modal-actions button:hover svg { color: var(--text-color); }

        .modal-body { flex-grow: 1; overflow: auto; padding: 1.5rem; }

        /* --- Estilos para o conteúdo PAGINADO --- */
        #pdf-preview-content-wrapper {
            display: flex; justify-content: center;
        }
        #pdf-preview-content {
            display: flex; flex-direction: column; align-items: center;
            gap: 1.5rem; transform-origin: top center; transition: transform 0.2s;
        }

        .page-container { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .page-number-indicator { font-size: 0.8rem; color: var(--muted-text-color); font-weight: 500; }

        .page-preview {
            background-color: white;
            width: 21cm;
            height: 29.7cm; /* A4-like height */
            box-shadow: 0 0 10px rgba(0,0,0,0.15);
            padding: var(--pdf-margin); /* Margem dinâmica */
            overflow: hidden; /* Garante que o conteúdo não vaze */
            font-size: var(--pdf-font-size); 
        }

        /* --- Estilo do Conteúdo Gerado (PROSE) --- */
        .prose { color: var(--text-color); line-height: 1.6; }
        .prose > :first-child { margin-top: 0 !important; }
        .prose h1, .prose h2, .prose h3 { margin-top: 1.5em; margin-bottom: 1em; font-weight: 700; page-break-after: avoid;}
        .prose h1 { font-size: 2em; } .prose h2 { font-size: 1.5em; } .prose h3 { font-size: 1.25em; }
        .prose p { margin-bottom: 1em; } .prose strong { font-weight: 700; } .prose em { font-style: italic; }
        .prose ul, .prose ol { padding-left: 1.5em; margin-bottom: 1em; } .prose li { margin-bottom: 0.5em; }
        .prose a { color: var(--primary-color); text-decoration: none; } .prose a:hover { text-decoration: underline; }
        .prose blockquote, .prose pre, .prose table, .prose img { page-break-inside: avoid; }
        .prose blockquote { border-left: 4px solid var(--border-color); padding-left: 1em; margin: 0 0 1em 0; color: var(--muted-text-color); font-style: italic; }
        .prose code { background-color: #f1f5f9; padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em; border: 1px solid var(--border-color);}
        .prose pre { background-color: #1e293b; color: #e2e8f0; padding: 1em; border-radius: 0.5rem; overflow-x: auto; }
        .prose pre code { background: none; padding: 0; border: none; }
        .prose table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
        .prose th, .prose td { border: 1px solid var(--border-color); padding: 0.5em 1em; text-align: left; }
        .prose th { background-color: #f1f5f9; font-weight: 600; }

        /* --- Documentos Salvos --- */
        .saved-documents-panel { margin-top: 3rem; padding: 1.5rem; background-color: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .saved-documents-panel h2 { font-size: 1.25rem; margin-bottom: 1rem; color: var(--text-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; }
        #saved-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .saved-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: var(--background-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .item-title { font-weight: 500; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 1rem; }
        .item-actions button { background: none; border: none; cursor: pointer; padding: 0.5rem; color: var(--muted-text-color); }
        .item-actions button:hover { background-color: #e2e8f0; color: var(--text-color); border-radius: 50%;}

        /* --- Responsividade --- */
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; }
            .controls-panel { position: static; }
        }
        @media (max-width: 480px) {
            header h1 { font-size: 2rem; }
            .modal-header { padding: 0.5rem 1rem; }
            .modal-header h4 { font-size: 1rem; }
            .modal-actions button svg { width: 20px; height: 20px; }
            .modal-body { padding: 1rem 0.5rem; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Conversor Markdown Pro</h1>
        <p>Cole seu texto, ajuste o visual, visualize em páginas e salve em PDF com perfeição.</p>
    </header>

    <main class="container">
        <div class="main-grid">
            <div class="editor-section">
                <h2>Seu Texto (Markdown)</h2>
                <textarea id="markdown-input" placeholder="Cole seu texto aqui..."></textarea>
            </div>
            
            <aside class="controls-panel">
                <div class="control-group">
                    <h3>Visualização</h3>
                    <div class="btn-group">
                        <button id="preview-raw-btn" class="btn btn-tertiary">Visualização Simples</button>
                        <button id="preview-pdf-btn" class="btn btn-tertiary">Visualização Paginada (PDF)</button>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Configurações do PDF</h3>
                    <div class="config-item">
                        <label for="font-size-input">Tamanho da Fonte (px)</label>
                        <input type="number" id="font-size-input" min="8" max="32" value="16">
                    </div>
                    <div class="config-item">
                        <label for="margin-input">Margens (mm)</label>
                        <input type="number" id="margin-input" min="5" max="50" value="20">
                    </div>
                    <button id="save-config-btn" class="btn btn-primary" style="width: 100%;">Salvar Configurações</button>
                </div>
                
                <div class="control-group">
                    <h3>Ações Finais</h3>
                    <div class="btn-group">
                        <button id="pdf-btn" class="btn btn-secondary">Baixar PDF</button>
                        <button id="save-btn" class="btn btn-primary">Salvar no Navegador</button>
                    </div>
                </div>
            </aside>
        </div>

        <div class="saved-documents-panel">
            <h2>Documentos Salvos</h2>
            <div id="saved-list"></div>
        </div>
    </main>

    <div id="preview-overlay"></div>
    <div id="preview-modal">
        <div class="modal-header">
            <h4 id="modal-title">Pré-visualização</h4>
            <div class="modal-actions">
                <button id="fullscreen-btn" title="Tela Cheia">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/></svg>
                </button>
                <button id="close-modal-btn" title="Fechar">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
        </div>
        <div class="modal-body" id="modal-body-content">
            </div>
    </div>
    
    <footer>
        <p>&copy; 2025 - Criado com ❤️ para facilitar sua vida.</p>
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Seleção de Elementos ---
            const markdownInput = document.getElementById('markdown-input');
            const saveBtn = document.getElementById('save-btn');
            const pdfBtn = document.getElementById('pdf-btn');
            const savedList = document.getElementById('saved-list');
            const previewRawBtn = document.getElementById('preview-raw-btn');
            const previewPdfBtn = document.getElementById('preview-pdf-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const fontSizeInput = document.getElementById('font-size-input');
            const marginInput = document.getElementById('margin-input');

            // --- Elementos do Modal ---
            const previewOverlay = document.getElementById('preview-overlay');
            const previewModal = document.getElementById('preview-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body-content');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');

            // --- Variável de estado para o listener de resize ---
            let isPaginatedPreviewOpen = false;
            
            // --- Funções do Modal ---
            const openModal = () => {
                previewOverlay.style.display = 'block';
                previewModal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Impede rolagem do fundo
            };
            const closeModal = () => {
                previewOverlay.style.display = 'none';
                previewModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                previewModal.classList.remove('fullscreen');
                isPaginatedPreviewOpen = false;
                window.removeEventListener('resize', scalePreviewToFit); // Remove o listener
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
            };
            
            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    previewModal.requestFullscreen().catch(err => {
                        alert(`Erro ao entrar em tela cheia: ${err.message}`);
                    });
                    previewModal.classList.add('fullscreen');
                } else {
                    document.exitFullscreen();
                    previewModal.classList.remove('fullscreen');
                }
            };
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    previewModal.classList.remove('fullscreen');
                }
                scalePreviewToFit(); // Re-escala ao sair/entrar em tela cheia
            });

            // --- Funções de Configuração ---
            const applySavedConfig = () => {
                const config = JSON.parse(localStorage.getItem('pdf_config')) || { fontSize: 16, margin: 20 };
                fontSizeInput.value = config.fontSize;
                marginInput.value = config.margin;
                document.documentElement.style.setProperty('--pdf-font-size', `${config.fontSize}px`);
                document.documentElement.style.setProperty('--pdf-margin', `${config.margin}mm`);
            };

            const saveConfig = () => {
                const config = { fontSize: fontSizeInput.value, margin: marginInput.value };
                localStorage.setItem('pdf_config', JSON.stringify(config));
                applySavedConfig();
                alert('Configurações salvas!');
            };

            // --- Funções de Pré-Visualização ---
            const showRawPreview = () => {
                isPaginatedPreviewOpen = false;
                modalTitle.textContent = 'Pré-visualização Simples';
                const markdownText = markdownInput.value;
                const rawHtml = marked.parse(markdownText || '### Nenhum conteúdo para visualizar.');
                modalBody.innerHTML = `<div class="prose" style="font-size: var(--pdf-font-size); max-width: 800px; margin: auto;">${rawHtml}</div>`;
                openModal();
            };
            
            const scalePreviewToFit = () => {
                const content = document.getElementById('pdf-preview-content');
                const wrapper = document.getElementById('pdf-preview-content-wrapper');
                if (!content || !wrapper) return;

                const wrapperWidth = wrapper.clientWidth;
                const contentWidth = content.offsetWidth;
                
                if (contentWidth > wrapperWidth) {
                    const scale = (wrapperWidth / contentWidth) * 0.98; // 98% para dar uma margem
                    content.style.transform = `scale(${scale})`;
                } else {
                    content.style.transform = 'scale(1)';
                }
            };

            const showPdfPreview = () => {
                modalTitle.textContent = 'Pré-visualização Paginada';
                const markdownText = markdownInput.value;
                if (markdownText.trim() === '') {
                    modalBody.innerHTML = '<p>Nenhum conteúdo para visualizar.</p>';
                    openModal();
                    return;
                }

                // Prepara a estrutura do corpo do modal
                modalBody.innerHTML = `<div id="pdf-preview-content-wrapper"><div id="pdf-preview-content"></div></div>`;
                const previewContent = document.getElementById('pdf-preview-content');
                
                // Área de teste invisível
                const stagingArea = document.createElement('div');
                stagingArea.className = 'prose';
                stagingArea.style.opacity = '0';
                stagingArea.style.position = 'absolute';
                stagingArea.style.width = `calc(21cm - (${(marginInput.value || 20) * 2}mm))`; // Largura do conteúdo
                stagingArea.style.fontSize = `${fontSizeInput.value || 16}px`;
                stagingArea.style.pointerEvents = 'none';
                stagingArea.innerHTML = marked.parse(markdownText);
                document.body.appendChild(stagingArea);

                const pageHeightPx = (29.7 * 37.795) - ((marginInput.value || 20) * 2 * 3.7795); // Altura útil da página em pixels

                let pageCounter = 1;
                let currentPage = createNewPage(pageCounter);
                previewContent.appendChild(currentPage.container);

                const elements = Array.from(stagingArea.children);
                for (const el of elements) {
                    const proseDiv = currentPage.proseDiv;
                    proseDiv.appendChild(el);

                    // Verifica overflow, mas previne loops infinitos com elementos muito grandes
                    if (proseDiv.scrollHeight > pageHeightPx && proseDiv.children.length > 1) {
                        proseDiv.removeChild(el); // Devolve o elemento que causou o estouro
                        pageCounter++;
                        currentPage = createNewPage(pageCounter);
                        previewContent.appendChild(currentPage.container);
                        currentPage.proseDiv.appendChild(el); // Adiciona na nova página
                    }
                }
                
                document.body.removeChild(stagingArea);
                openModal();

                isPaginatedPreviewOpen = true;
                setTimeout(() => { // Garante que o DOM foi renderizado antes de escalar
                    scalePreviewToFit();
                    window.addEventListener('resize', scalePreviewToFit);
                }, 100);
            };

            function createNewPage(pageNumber) {
                const container = document.createElement('div');
                container.className = 'page-container';
                
                const numberIndicator = document.createElement('h3');
                numberIndicator.className = 'page-number-indicator';
                numberIndicator.textContent = `Página ${pageNumber}`;
                
                const page = document.createElement('div');
                page.className = 'page-preview';
                
                const proseDiv = document.createElement('div');
                proseDiv.className = 'prose';
                page.appendChild(proseDiv);

                container.appendChild(numberIndicator);
                container.appendChild(page);

                return { container, proseDiv };
            }

            // --- Download como PDF ---
            const downloadPDF = () => {
                const markdownText = markdownInput.value;
                if (markdownText.trim() === '') {
                    alert('Não há conteúdo para converter para PDF.');
                    return;
                }
                
                const element = document.createElement('div');
                const proseEl = document.createElement('div');
                proseEl.className = 'prose';
                proseEl.innerHTML = marked.parse(markdownText);
                element.appendChild(proseEl);

                // Aplica estilos para o html2pdf capturar corretamente
                const fontSize = getComputedStyle(document.documentElement).getPropertyValue('--pdf-font-size');
                proseEl.style.fontSize = fontSize;
                
                const now = new Date();
                const filename = `documento-${now.toISOString().slice(0,10)}.pdf`;
                const marginInches = (parseFloat(marginInput.value) || 20) / 25.4;

                const opt = {
                    margin: marginInches,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
                    pagebreak: { mode: ['css', 'legacy'] }
                };
                html2pdf().set(opt).from(element).save();
            };

            // --- Armazenamento Local (Documentos) ---
            const getSavedDocuments = () => JSON.parse(localStorage.getItem('markdown_docs')) || [];
            const saveDocuments = (docs) => localStorage.setItem('markdown_docs', JSON.stringify(docs));

            const renderSavedDocuments = () => {
                const docs = getSavedDocuments();
                savedList.innerHTML = docs.length === 0 ? '<p style="color: var(--muted-text-color);">Nenhum documento salvo ainda.</p>' : '';
                docs.forEach(doc => {
                    const item = document.createElement('div');
                    item.className = 'saved-item';
                    item.dataset.id = doc.id;
                    item.innerHTML = `<span class="item-title" title="Carregar: ${doc.title}">${doc.title}</span><div class="item-actions"><button class="edit-btn" title="Editar Nome"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.5 3.793 12.207 1.5zM1 13.5l1.5-1.5L4 13.5 2.5 15H1z"/></svg></button><button class="delete-btn" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1z"/></svg></button></div>`;
                    savedList.appendChild(item);
                });
            };

            const saveCurrentDocument = () => {
                const content = markdownInput.value;
                if (content.trim() === '') { alert('Não há conteúdo para salvar.'); return; }
                const title = prompt('Digite um nome para este documento:', 'Novo Documento');
                if (!title || title.trim() === '') return;
                const docs = getSavedDocuments();
                const newDoc = { id: Date.now().toString(), title: title.trim(), content };
                docs.push(newDoc);
                saveDocuments(docs);
                renderSavedDocuments();
            };
            
            const handleSavedListClick = (e) => {
                const item = e.target.closest('.saved-item');
                if (!item) return;
                const docId = item.dataset.id;
                let docs = getSavedDocuments();
                const docIndex = docs.findIndex(d => d.id === docId);

                if (e.target.closest('.item-title')) { // Carregar
                    markdownInput.value = docs[docIndex].content;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (e.target.closest('.edit-btn')) { // Editar
                    const newTitle = prompt('Novo nome:', docs[docIndex].title);
                    if (newTitle && newTitle.trim() !== '') {
                        docs[docIndex].title = newTitle.trim();
                        saveDocuments(docs);
                        renderSavedDocuments();
                    }
                } else if (e.target.closest('.delete-btn')) { // Excluir
                    if (confirm(`Excluir "${docs[docIndex].title}"?`)) {
                        docs = docs.filter(d => d.id !== docId);
                        saveDocuments(docs);
                        renderSavedDocuments();
                    }
                }
            };

            // --- Event Listeners ---
            saveBtn.addEventListener('click', saveCurrentDocument);
            pdfBtn.addEventListener('click', downloadPDF);
            savedList.addEventListener('click', handleSavedListClick);
            saveConfigBtn.addEventListener('click', saveConfig);
            previewRawBtn.addEventListener('click', showRawPreview);
            previewPdfBtn.addEventListener('click', showPdfPreview);
            closeModalBtn.addEventListener('click', closeModal);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            previewOverlay.addEventListener('click', closeModal);
            
            // --- Inicialização ---
            applySavedConfig();
            renderSavedDocuments();
        });
    </script>

</body>
</html>
