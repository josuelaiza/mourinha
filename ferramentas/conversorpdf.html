<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Sorteio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Classe customizada para controlar o menu, evitando conflitos */
        .menu-closed {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Navbar -->
    <nav class="bg-white shadow-md p-4 flex justify-between items-center fixed top-0 left-0 right-0 z-20">
        <h1 class="text-xl font-bold text-blue-600">Sorteio B.A.M.N</h1>
        <button id="hamburger-button" class="md:hidden p-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </nav>

    <!-- Menu Lateral (Hamburguer) -->
    <div id="side-menu" class="fixed top-0 right-0 h-full w-64 bg-white shadow-lg z-30 transform transition-transform duration-300 ease-in-out menu-closed">
        <div class="p-4 flex justify-end">
            <button id="close-menu-button" class="p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <ul class="mt-4">
            <li><a href="#" id="admin-menu-button" class="block py-2 px-4 text-gray-700 hover:bg-gray-200">Administrador</a></li>
        </ul>
    </div>
    <div id="menu-overlay" class="fixed inset-0 bg-black opacity-50 z-20 hidden"></div>


    <main class="pt-20 flex items-center justify-center min-h-screen">
        <div class="container mx-auto p-4 max-w-lg w-full">

            <!-- Tela de Carregamento -->
            <div id="loading-view" class="text-center">
                <p class="text-lg font-semibold">Carregando...</p>
            </div>

            <!-- Tela de Cadastro -->
            <div id="registration-view" class="hidden">
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-center">Cadastro para Sorteio</h2>
                    <form id="registration-form">
                        <div class="mb-4">
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                            <input type="text" id="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-6">
                            <label for="cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF</label>
                            <input type="text" id="cpf" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="000.000.000-00" maxlength="14">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition duration-300 font-semibold">Participar e Ativar Notificações</button>
                    </form>
                </div>
            </div>

            <!-- Tela de Espera -->
            <div id="waiting-view" class="hidden text-center bg-white p-8 rounded-lg shadow-lg">
                <h2 id="waiting-title" class="text-2xl font-bold mb-4 text-green-600">Cadastro realizado com sucesso!</h2>
                <p id="waiting-message" class="text-gray-600 mb-6">Aguardando o próximo sorteio.</p>
                <div id="countdown-timer" class="text-4xl font-bold text-blue-600"></div>
            </div>
            
            <!-- Tela de Vencedor -->
            <div id="winner-view" class="hidden text-center bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold mb-4 text-yellow-500">Parabéns! Você foi o vencedor!</h2>
                <p class="text-gray-700 mb-6">Por favor, confirme sua ciência para receber o prêmio.</p>
                <div class="flex items-center justify-center space-x-3 bg-gray-100 p-4 rounded-md">
                    <input type="checkbox" id="winner-confirmation-checkbox" class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="winner-confirmation-checkbox" class="font-medium text-gray-800">Estou ciente que fui sorteado e irei ao palco buscar meu prêmio.</label>
                </div>
                 <p id="confirmation-success" class="text-green-600 mt-4 font-semibold hidden">Confirmação enviada com sucesso!</p>
            </div>

            <!-- Tela de Resultado (Não Vencedor) -->
            <div id="result-view" class="hidden text-center bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4">Sorteio Realizado!</h2>
                <p class="text-gray-600 mb-2">O vencedor foi:</p>
                <p id="winner-name-display" class="text-3xl font-bold text-blue-600"></p>
            </div>

            <!-- Painel do Administrador -->
            <div id="admin-panel-view" class="hidden w-full max-w-4xl">
                 <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-6">Painel do Administrador</h2>
                    <div class="mb-8 border-b pb-6">
                        <h3 class="text-lg font-semibold mb-3">Agendar Sorteio</h3>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="datetime-local" id="draw-time-input" class="flex-grow px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="set-draw-time-button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-300">Agendar</button>
                        </div>
                    </div>
                    <div class="mb-8 border-b pb-6">
                        <h3 class="text-lg font-semibold mb-3">Status do Vencedor</h3>
                        <div id="winner-status" class="bg-gray-100 p-4 rounded-md"></div>
                    </div>
                    <div class="mb-8 border-b pb-6">
                        <h3 class="text-lg font-semibold mb-3">Participantes Cadastrados (<span id="participant-count">0</span>)</h3>
                        <div id="participant-list-container" class="h-64 overflow-y-auto border rounded-md p-2 bg-gray-50">
                            <ul id="participant-list"></ul>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-red-600">Área de Perigo</h3>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="reset-participants-button" class="w-full bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition duration-300">Resetar Lista de Candidatos</button>
                            <button id="general-reset-button" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition duration-300">Reset Geral</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal de Senha do Admin -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4">Acesso Restrito</h3>
            <p class="text-gray-600 mb-4">Por favor, insira a senha de administrador.</p>
            <input type="password" id="admin-password-input" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-end gap-3">
                 <button id="cancel-admin-login" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400">Cancelar</button>
                <button id="submit-admin-password" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Entrar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWqJlUVobXs859hfxaM6eT_dU5U2YIHQk",
            authDomain: "sorteiobamn.firebaseapp.com",
            databaseURL: "https://sorteiobamn-default-rtdb.firebaseio.com",
            projectId: "sorteiobamn",
            storageBucket: "sorteiobamn.firebasestorage.app",
            messagingSenderId: "427382818317",
            appId: "1:427382818317:web:9f745b6f0afa86b5093744"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const views = { loading: document.getElementById('loading-view'), registration: document.getElementById('registration-view'), waiting: document.getElementById('waiting-view'), winner: document.getElementById('winner-view'), result: document.getElementById('result-view'), adminPanel: document.getElementById('admin-panel-view') };
        const registrationForm = document.getElementById('registration-form');
        const nameInput = document.getElementById('name');
        const cpfInput = document.getElementById('cpf');
        const countdownTimer = document.getElementById('countdown-timer');
        const waitingMessage = document.getElementById('waiting-message');
        const winnerNameDisplay = document.getElementById('winner-name-display');
        const winnerCheckbox = document.getElementById('winner-confirmation-checkbox');
        const confirmationSuccessMsg = document.getElementById('confirmation-success');
        const adminLoginModal = document.getElementById('admin-login-modal');
        const adminMenuButton = document.getElementById('admin-menu-button');
        const cancelAdminLogin = document.getElementById('cancel-admin-login');
        const submitAdminPassword = document.getElementById('submit-admin-password');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const drawTimeInput = document.getElementById('draw-time-input');
        const setDrawTimeButton = document.getElementById('set-draw-time-button');
        const participantList = document.getElementById('participant-list');
        const participantCount = document.getElementById('participant-count');
        const winnerStatus = document.getElementById('winner-status');
        const resetParticipantsButton = document.getElementById('reset-participants-button');
        const generalResetButton = document.getElementById('general-reset-button');
        const hamburgerButton = document.getElementById('hamburger-button');
        const sideMenu = document.getElementById('side-menu');
        const closeMenuButton = document.getElementById('close-menu-button');
        const menuOverlay = document.getElementById('menu-overlay');

        let countdownInterval;
        let currentUserCPF = localStorage.getItem('userCPF');
        let winnerAnnounced = false; // Flag para controlar o envio da notificação

        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
        }

        function formatCPF(cpf) {
            return cpf.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        }

        function getManausTime() {
            return new Date().toLocaleString("pt-BR", { timeZone: "America/Manaus", hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function sendNotification(title, options) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, options);
                notification.onclick = () => window.focus();
            }
        }

        function initApp() {
            onValue(ref(db), (snapshot) => {
                const data = snapshot.val() || {};
                const config = data.config || {};
                const participants = data.participants || {};
                const winner = data.winner || null;
                
                // CORREÇÃO 3: Lógica de notificação baseada na mudança do DB
                if (winner && !winnerAnnounced) {
                    winnerAnnounced = true;
                    sendNotification("O sorteio acabou de acontecer!", { body: "Clique para ver o resultado." });
                    if (currentUserCPF && currentUserCPF === winner.cpf) {
                        setTimeout(() => {
                            sendNotification("🎉 Você foi o vencedor! 🎉", { body: "Parabéns! Clique aqui para confirmar sua ciência." });
                        }, 1500);
                    }
                }
                
                if (!winner) winnerAnnounced = false; // Reseta a flag se o sorteio for resetado

                updateAdminPanel(participants, winner, config);

                if (winner) {
                    if (currentUserCPF && currentUserCPF === winner.cpf) {
                        showView('winner');
                        winnerCheckbox.checked = !!winner.confirmed;
                        winnerCheckbox.disabled = !!winner.confirmed;
                        if(winner.confirmed) confirmationSuccessMsg.classList.remove('hidden');
                    } else {
                        showView('result');
                        winnerNameDisplay.textContent = winner.name;
                    }
                    if (countdownInterval) clearInterval(countdownInterval);
                    return;
                }

                if (currentUserCPF && participants[currentUserCPF.replace(/\D/g, '')]) {
                    showView('waiting');
                    if (config.drawTime) {
                        startCountdown(config.drawTime);
                    } else {
                        waitingMessage.textContent = "Nenhum sorteio agendado no momento. Aguarde!";
                        countdownTimer.textContent = "";
                        if (countdownInterval) clearInterval(countdownInterval);
                    }
                } else {
                    localStorage.removeItem('userCPF');
                    currentUserCPF = null;
                    showView('registration');
                }
            }, { onlyOnce: false });
            showView('loading');
        }

        function startCountdown(drawTime) {
            if (countdownInterval) clearInterval(countdownInterval);
            waitingMessage.textContent = "O sorteio acontecerá em:";
            countdownInterval = setInterval(() => {
                const distance = drawTime - new Date().getTime();
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    countdownTimer.textContent = "SORTEIO EM ANDAMENTO!";
                    // Apenas um cliente precisa acionar o sorteio
                    get(ref(db, 'winner')).then(snapshot => {
                        if (!snapshot.exists()) triggerDraw();
                    });
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                countdownTimer.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }, 1000);
        }
        
        async function triggerDraw() {
            const snapshot = await get(ref(db, 'participants'));
            const participantsData = snapshot.val();
            if (participantsData) {
                const participantsArray = Object.values(participantsData);
                if (participantsArray.length > 0) {
                    const winnerIndex = Math.floor(Math.random() * participantsArray.length);
                    const winner = participantsArray[winnerIndex];
                    await set(ref(db, 'winner'), { name: winner.name, cpf: winner.cpf, confirmed: false, confirmationTimestamp: null });
                }
            }
        }

        function updateAdminPanel(participants, winner, config) {
            participantList.innerHTML = '';
            const participantKeys = Object.keys(participants);
            participantCount.textContent = participantKeys.length;
            if (participantKeys.length > 0) {
                participantKeys.forEach(key => {
                    const li = document.createElement('li');
                    li.className = "p-2 border-b text-sm";
                    li.textContent = `${participants[key].name} - ${participants[key].cpf}`;
                    participantList.appendChild(li);
                });
            } else {
                 participantList.innerHTML = '<li class="p-2 text-sm text-gray-500">Nenhum participante cadastrado.</li>';
            }

            if (winner) {
                const confirmationText = winner.confirmed ? `Confirmado em: ${winner.confirmationTimestamp}` : 'Aguardando confirmação do vencedor.';
                winnerStatus.innerHTML = `<p><strong>Vencedor:</strong> ${winner.name}</p><p><strong>CPF:</strong> ${winner.cpf}</p><p><strong>Status:</strong> <span class="${winner.confirmed ? 'text-green-600' : 'text-yellow-600'}">${confirmationText}</span></p>`;
            } else {
                winnerStatus.innerHTML = `<p>Ainda não houve sorteio ou foi resetado.</p>`;
            }
        }

        function saveParticipant(name, cpf) {
            const cleanCPF = cpf.replace(/\D/g, '');
            set(ref(db, `participants/${cleanCPF}`), { name, cpf });
            localStorage.setItem('userCPF', cpf);
            currentUserCPF = cpf;
        }

        registrationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            const cpf = cpfInput.value.trim();

            if (name && cpf.length === 14) {
                // CORREÇÃO 1: Pedir permissão como resultado direto da ação do usuário
                if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission().then(() => {
                        saveParticipant(name, cpf);
                    });
                } else {
                    saveParticipant(name, cpf);
                }
            } else {
                alert('Por favor, preencha nome e CPF corretamente.');
            }
        });
        
        cpfInput.addEventListener('input', (e) => { e.target.value = formatCPF(e.target.value); });

        winnerCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                const timestamp = getManausTime();
                set(ref(db, 'winner/confirmed'), true);
                set(ref(db, 'winner/confirmationTimestamp'), timestamp);
            }
        });

        adminMenuButton.addEventListener('click', () => {
            adminLoginModal.classList.remove('hidden');
            closeMenu();
        });

        cancelAdminLogin.addEventListener('click', () => { adminLoginModal.classList.add('hidden'); adminPasswordInput.value = ''; });

        submitAdminPassword.addEventListener('click', () => {
            if (adminPasswordInput.value === '1234') {
                adminLoginModal.classList.add('hidden');
                adminPasswordInput.value = '';
                showView('adminPanel');
            } else {
                alert('Senha incorreta!');
            }
        });

        setDrawTimeButton.addEventListener('click', () => {
            const drawTimeValue = drawTimeInput.value;
            if (drawTimeValue) {
                set(ref(db, 'config/drawTime'), new Date(drawTimeValue).getTime());
                alert('Horário do sorteio definido com sucesso!');
            } else {
                alert('Por favor, selecione uma data e hora.');
            }
        });

        resetParticipantsButton.addEventListener('click', () => {
            if (confirm('Tem certeza que deseja apagar a lista de TODOS os candidatos?')) {
                remove(ref(db, 'participants'));
                alert('Lista de participantes apagada.');
            }
        });

        generalResetButton.addEventListener('click', () => {
            if (confirm('!! ATENÇÃO !!\nTem certeza que deseja fazer um RESET GERAL? Isso apagará TODOS os dados.')) {
                remove(ref(db));
                alert('Reset geral concluído.');
                localStorage.removeItem('userCPF');
                window.location.reload();
            }
        });

        // CORREÇÃO 2: Lógica do Menu Hamburguer
        function openMenu() {
            sideMenu.classList.remove('menu-closed');
            menuOverlay.classList.remove('hidden');
        }
        function closeMenu() {
            sideMenu.classList.add('menu-closed');
            menuOverlay.classList.add('hidden');
        }
        hamburgerButton.addEventListener('click', openMenu);
        closeMenuButton.addEventListener('click', closeMenu);
        menuOverlay.addEventListener('click', closeMenu);
        
        window.onload = initApp;
    </script>
</body>
</html>
