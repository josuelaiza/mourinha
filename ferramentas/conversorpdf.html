<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteio Domingo A√©reo - BAMN (Online)</title>
    <style>
        :root {
            --primary-color: #005f9e;
            --secondary-color: #f5a623;
            --success-color: #5cb85c;
            --danger-color: #d9534f;
            --background-color: #f4f7fa;
            --text-color: #333;
            --light-gray-color: #e1e1e1;
            --white-color: #fff;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; background: var(--white-color); border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        header { display: flex; justify-content: space-between; align-items: center; text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--primary-color); position: relative; }
        header .header-content { flex-grow: 1; }
        header h1 { color: var(--primary-color); font-size: 2em; }
        header p { font-size: 1.1em; color: #666; }
        #connection-status { font-size: 0.8em; padding: 2px 8px; border-radius: 10px; color: white; position: absolute; top: 5px; right: 5px; }
        #connection-status.connected { background-color: var(--success-color); }
        #connection-status.disconnected { background-color: var(--danger-color); }

        #menu-toggle { background: none; border: none; cursor: pointer; padding: 10px; z-index: 1001; }
        #menu-toggle .bar { display: block; width: 25px; height: 3px; background-color: var(--primary-color); margin: 5px 0; transition: 0.4s; }
        #menu-panel { position: absolute; top: 60px; right: 0; background-color: var(--white-color); border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); list-style: none; padding: 10px 0; z-index: 1000; width: 250px; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.3s, transform 0.3s, visibility 0.3s; }
        #menu-panel.open { opacity: 1; visibility: visible; transform: translateY(0); }
        #menu-panel li button, #menu-panel li label { display: block; width: 100%; padding: 12px 20px; background: none; border: none; text-align: left; font-size: 1em; cursor: pointer; color: var(--text-color); }
        #menu-panel li button:hover, #menu-panel li label:hover { background-color: #f0f0f0; }
        #menu-panel li.separator { height: 1px; background-color: var(--light-gray-color); margin: 8px 0; }
        #menu-panel li button.danger-text { color: var(--danger-color); font-weight: bold; }
        #menu-panel li .btn-menu-success { color: var(--success-color); font-weight: bold; }
        #menu-panel li .btn-menu-secondary { color: var(--primary-color); }

        .form-group, .paste-group { margin-bottom: 15px; }
        .form-group label, .paste-group label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--primary-color); }
        .form-group input, .form-group select, .paste-group textarea, #bulk-paste-area { width: 100%; padding: 12px; border: 1px solid var(--light-gray-color); border-radius: 5px; font-size: 1em; font-family: var(--font-family); }
        .form-group input[type="checkbox"] { width: auto; margin-right: 10px; }
        .form-group input:focus, .form-group select:focus, .paste-group textarea:focus, #bulk-paste-area:focus { outline: none; border-color: var(--primary-color); }
        .paste-group textarea { resize: vertical; min-height: 60px; }
        #bulk-paste-area { min-height: 200px; resize: vertical; }

        .btn { display: inline-block; padding: 12px 20px; font-size: 1em; font-weight: bold; text-align: center; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; text-decoration: none; color: var(--white-color); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        .btn-full-width { width: 100%; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover:not(:disabled) { background-color: #004c8c; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover:not(:disabled) { background-color: #d88e1a; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover:not(:disabled) { background-color: #449d44; }

        .main-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        #participant-list { margin-top: 25px; display: none; }
        #list-container, #winners-list-container { border-top: 1px solid var(--light-gray-color); padding-top: 15px; max-height: 400px; overflow-y: auto; }
        #search-box { width: 100%; padding: 10px; font-size: 1em; border: 1px solid var(--light-gray-color); border-radius: 5px; margin-bottom: 15px; }
        
        .participant-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--light-gray-color); }
        .participant-info { flex-grow: 1; }
        .participant-info .name { font-weight: bold; font-size: 1.1em; }
        .participant-info .details { font-size: 0.9em; color: #555; }
        .participant-actions button { background: none; border: none; cursor: pointer; padding: 5px; margin-left: 8px; flex-shrink: 0; }
        .participant-actions svg { width: 24px; height: 24px; }
        .edit-btn svg { fill: var(--primary-color); }
        .delete-btn svg { fill: var(--danger-color); }
        
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; }
        .modal-content { background-color: var(--white-color); padding: 25px; border-radius: 10px; text-align: center; max-width: 90%; width: 500px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal h2 { margin-bottom: 15px; color: var(--primary-color); }
        #lucky-number-display, #winner-name { font-size: 2.5em; font-weight: bold; color: var(--primary-color); margin: 15px 0; }
        #winner-details { font-size: 1.2em; margin-bottom: 20px; line-height: 1.5; }
        .winner-highlight { background-color: #fff3cd !important; border: 2px solid var(--secondary-color); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div id="connection-status" class="disconnected">Offline</div>
            <div class="header-content">
                <h1>Domingo A√©reo - Sorteio Online</h1>
                <p>Doe 1kg de alimento e concorra!</p>
            </div>
            <button id="menu-toggle" aria-label="Abrir menu">
                <span class="bar"></span><span class="bar"></span><span class="bar"></span>
            </button>
            <ul id="menu-panel">
                <li><button id="draw-btn" class="btn-menu-success">Realizar Sorteio</button></li>
                <li><button id="bulk-add-btn" class="btn-menu-secondary">Cadastro em Lote</button></li>
                <li class="separator"></li>
                <li><button id="toggle-smart-add-btn">Exibir Preenchimento R√°pido</button></li>
                <li><button id="view-winners-btn">Ver Sorteados</button></li>
                <li>
                    <label for="import-file-menu" style="width: 100%; cursor: pointer;">Importar Lista (JSON)</label>
                    <input type="file" id="import-file-menu" accept=".json" style="display: none;">
                </li>
                <li class="separator"></li>
                <li><button id="delete-all-btn" class="danger-text">Apagar Lista de Participantes</button></li>
                <li><button id="reset-all-btn" class="danger-text">Resetar Tudo</button></li>
            </ul>
        </header>

        <main>
            <div id="smart-add-section" class="paste-group" style="display: none;">
                <label for="paste-area">Preenchimento R√°pido (Individual)</label>
                <textarea id="paste-area" placeholder="Cole o nome e o documento (CPF, RG ou Data de Nasc.) de uma pessoa aqui..."></textarea>
                <button id="parse-btn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">Analisar e Preencher</button>
            </div>
            
            <hr id="main-separator" style="border: none; border-top: 1px dashed var(--light-gray-color); margin: 25px 0; display: none;">

            <form id="participant-form">
                <div class="form-group">
                    <label for="fullName">Nome Completo</label>
                    <input type="text" id="fullName" required>
                </div>
                <div class="form-group">
                    <label for="doc-type">Tipo de Documento</label>
                    <select id="doc-type">
                        <option value="CPF" selected>CPF</option>
                        <option value="RG">RG</option>
                        <option value="Nascimento">Data de Nascimento</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="doc-number-label" for="doc-number">CPF (apenas n√∫meros)</label>
                    <input type="tel" id="doc-number" required pattern="\d{11}" title="Digite os 11 d√≠gitos do CPF.">
                </div>
                <button type="submit" class="btn btn-primary btn-full-width">Gerar N√∫mero da Sorte</button>
            </form>

            <div class="main-actions">
                <button id="toggle-list-btn" class="btn btn-secondary">Visualizar Lista</button>
            </div>
            
            <section id="participant-list">
                <h2 style="color: var(--primary-color); margin-bottom: 15px;">Lista de Participantes</h2>
                <input type="text" id="search-box" placeholder="Buscar por nome ou documento...">
                <div id="list-container"></div>
                <div style="margin-top: 15px;">
                    <a id="download-json-btn" class="btn btn-secondary" href="#">Download (JSON)</a>
                    <a id="download-csv-btn" class="btn btn-secondary" href="#">Download (CSV)</a>
                </div>
            </section>
        </main>
    </div>

    <div id="lucky-number-modal" class="modal"><div class="modal-content"><h2>N√∫mero da Sorte Gerado!</h2><p>Informe este n√∫mero para o participante:</p><div id="lucky-number-display"></div><button class="btn btn-primary close-modal-btn">Fechar</button></div></div>
    <div id="winner-modal" class="modal"><div class="modal-content"><h2>üéâ Parab√©ns ao Vencedor! üéâ</h2><div id="winner-name"></div><div id="winner-details"></div><button class="btn btn-primary close-modal-btn">Fechar</button></div></div>
    <div id="edit-modal" class="modal"><div class="modal-content"><h2>Editar Participante</h2><form id="edit-form"><input type="hidden" id="edit-id"><div class="form-group" style="text-align: left;"><label for="edit-fullName">Nome Completo</label><input type="text" id="edit-fullName" required></div><div class="form-group" style="text-align: left;"><label for="edit-doc">Documento (n√£o pode ser alterado)</label><input type="text" id="edit-doc" readonly></div><button type="submit" class="btn btn-primary">Salvar</button><button type="button" class="btn btn-secondary close-modal-btn" style="margin-top: 10px;">Cancelar</button></form></div></div>
    <div id="winners-list-modal" class="modal"><div class="modal-content"><h2>üèÜ Lista de Sorteados üèÜ</h2><div id="winners-list-container"></div><button class="btn btn-primary close-modal-btn" style="margin-top: 20px;">Fechar</button></div></div>
    <div id="bulk-add-modal" class="modal"><div class="modal-content"><h2>Cadastro de M√∫ltiplos Participantes</h2><p style="margin-bottom:15px; text-align:left;">Cole a lista abaixo (um participante por linha). Ex: Nome Completo 12345678901</p><textarea id="bulk-paste-area"></textarea><div style="display:flex; gap:10px; margin-top:15px;"><button id="process-bulk-list-btn" class="btn btn-success" style="flex-grow:1;">Processar Lista</button><button type="button" class="btn btn-secondary close-modal-btn" style="flex-grow:1;">Cancelar</button></div></div></div>
    <div id="draw-options-modal" class="modal"><div class="modal-content"><h2>Op√ß√µes do Sorteio</h2><form id="draw-options-form"><div class="form-group" style="text-align: left; display: flex; align-items: center;"><input type="checkbox" id="exclude-winners-checkbox" checked><label for="exclude-winners-checkbox" style="margin-bottom: 0;">Excluir j√° sorteados da lista</label></div><div style="display:flex; gap:10px; margin-top:15px;"><button type="submit" class="btn btn-success" style="flex-grow:1;">Sortear!</button><button type="button" class="btn btn-secondary close-modal-btn" style="flex-grow:1;">Cancelar</button></div></form></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
    // SUA CHAVE J√Å EST√Å INSERIDA AQUI
    const firebaseConfig = {
        apiKey: "AIzaSyAWqJlUVobXs859hfxaM6eT_dU5U2YIHQk",
        authDomain: "sorteiobamn.firebaseapp.com",
        databaseURL: "https://sorteiobamn-default-rtdb.firebaseio.com",
        projectId: "sorteiobamn",
        storageBucket: "sorteiobamn.appspot.com",
        messagingSenderId: "427382818317",
        appId: "1:427382818317:web:9f745b6f0afa86b5093744"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    document.addEventListener('DOMContentLoaded', () => {
        let participants = [];
        let winners = [];

        const participantsRef = database.ref('participants');
        const winnersRef = database.ref('winners');

        // Seletores de elementos
        const form = document.getElementById('participant-form');
        const fullNameInput = document.getElementById('fullName');
        const docTypeSelect = document.getElementById('doc-type');
        const docNumberInput = document.getElementById('doc-number');
        const docNumberLabel = document.getElementById('doc-number-label');
        const drawBtn = document.getElementById('draw-btn');
        const toggleListBtn = document.getElementById('toggle-list-btn');
        const bulkAddBtn = document.getElementById('bulk-add-btn');
        const participantListSection = document.getElementById('participant-list');
        const listContainer = document.getElementById('list-container');
        const searchBox = document.getElementById('search-box');
        const menuToggle = document.getElementById('menu-toggle');
        const menuPanel = document.getElementById('menu-panel');
        const viewWinnersBtn = document.getElementById('view-winners-btn');
        const modals = document.querySelectorAll('.modal');
        const luckyNumberModal = document.getElementById('lucky-number-modal');
        const winnerModal = document.getElementById('winner-modal');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const winnersListModal = document.getElementById('winners-list-modal');
        const bulkAddModal = document.getElementById('bulk-add-modal');
        const bulkPasteArea = document.getElementById('bulk-paste-area');
        const processBulkListBtn = document.getElementById('process-bulk-list-btn');
        const drawOptionsModal = document.getElementById('draw-options-modal');
        const drawOptionsForm = document.getElementById('draw-options-form');
        const connectionStatus = document.getElementById('connection-status');
        const smartAddSection = document.getElementById('smart-add-section');
        const toggleSmartAddBtn = document.getElementById('toggle-smart-add-btn');
        const mainSeparator = document.getElementById('main-separator');

        // --- L√ìGICA DE VISIBILIDADE DO PREENCHIMENTO R√ÅPIDO ---
        const setupSmartAddVisibility = () => {
            const isVisible = localStorage.getItem('smartAddVisible') === 'true';
            smartAddSection.style.display = isVisible ? 'block' : 'none';
            mainSeparator.style.display = isVisible ? 'block' : 'none';
            toggleSmartAddBtn.textContent = isVisible ? 'Ocultar Preenchimento R√°pido' : 'Exibir Preenchimento R√°pido';
        };

        toggleSmartAddBtn.addEventListener('click', () => {
            const isVisible = smartAddSection.style.display === 'block';
            localStorage.setItem('smartAddVisible', !isVisible);
            setupSmartAddVisibility();
            menuPanel.classList.remove('open');
        });
        
        setupSmartAddVisibility(); 

        // --- L√ìGICA DE CONEX√ÉO COM FIREBASE ---
        database.ref('.info/connected').on('value', (snap) => {
            connectionStatus.textContent = snap.val() ? 'Online' : 'Offline';
            connectionStatus.className = snap.val() ? 'connected' : 'disconnected';
        });

        participantsRef.on('value', (snapshot) => {
            participants = snapshot.val() ? Object.values(snapshot.val()) : [];
            updateButtonStates();
            if (participantListSection.style.display === 'block') renderList();
        });
        
        winnersRef.on('value', (snapshot) => {
            winners = snapshot.val() ? Object.values(snapshot.val()) : [];
        });
        
        // --- ATUALIZA√á√ÉO DO FORMUL√ÅRIO DE DOCUMENTO ---
        docTypeSelect.addEventListener('change', () => {
            const type = docTypeSelect.value;
            if (type === 'CPF') {
                docNumberLabel.textContent = 'CPF (apenas n√∫meros)';
                docNumberInput.pattern = '\\d{11}';
                docNumberInput.title = 'Digite os 11 d√≠gitos do CPF.';
                docNumberInput.placeholder = '';
            } else if (type === 'RG') {
                docNumberLabel.textContent = 'RG (apenas n√∫meros)';
                docNumberInput.pattern = '\\d{9}';
                docNumberInput.title = 'Digite os 9 d√≠gitos do RG.';
                docNumberInput.placeholder = '';
            } else { // Nascimento
                docNumberLabel.textContent = 'Data de Nascimento (DDMMAAAA)';
                docNumberInput.pattern = '\\d{8}';
                docNumberInput.title = 'Digite 8 n√∫meros (DDMMAAAA).';
                docNumberInput.placeholder = 'Ex: 25121990';
            }
            docNumberInput.value = '';
        });

        const updateButtonStates = () => drawBtn.disabled = participants.length === 0;

        const renderList = () => {
            const searchTerm = searchBox.value.toLowerCase();
            const filtered = participants.filter(p => p.name.toLowerCase().includes(searchTerm) || p.docNumber.includes(searchTerm));
            listContainer.innerHTML = filtered.length === 0 ? `<p>${participants.length === 0 ? 'Nenhum participante.' : 'Nenhum resultado.'}</p>` : '';
            
            filtered.sort((a, b) => a.luckyNumber - b.luckyNumber);

            filtered.forEach(p => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <div class="participant-info">
                        <div class="name">#${p.luckyNumber} - ${p.name}</div>
                        <div class="details">${p.docType}: ${p.docNumber}</div>
                    </div>
                    <div class="participant-actions">
                        <button class="edit-btn" data-id="${p.id}" title="Editar"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg></button>
                        <button class="delete-btn" data-id="${p.id}" title="Apagar"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg></button>
                    </div>`;
                listContainer.appendChild(item);
            });
            attachActionListeners();
        };
        
        const attachActionListeners = () => {
            document.querySelectorAll('.delete-btn').forEach(b => b.onclick = e => {
                const idToDelete = e.currentTarget.getAttribute('data-id');
                const p = participants.find(p => p.id === idToDelete);
                if (p && confirm(`Apagar "${p.name}"?`)) participantsRef.child(idToDelete).remove();
            });
            document.querySelectorAll('.edit-btn').forEach(b => b.onclick = e => openEditModal(e.currentTarget.getAttribute('data-id')));
        };
        
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = fullNameInput.value.trim();
            const docType = docTypeSelect.value;
            const docNumber = docNumberInput.value.replace(/\D/g, '');

            if (!name || !docNumberInput.checkValidity()) return alert('Verifique os dados. Nome √© obrigat√≥rio e o documento deve seguir o formato correto.');
            if (docType !== 'Nascimento' && participants.some(p => p.docType === docType && p.docNumber === docNumber)) return alert(`${docType} j√° cadastrado.`);

            const lastLuckyNumber = participants.length > 0 ? Math.max(...participants.map(p => p.luckyNumber)) : 0;
            const firebaseId = (docType !== 'Nascimento') ? `${docType}_${docNumber}` : `Nasc_${docNumber}_${Date.now()}`;

            const newParticipant = { 
                id: firebaseId,
                luckyNumber: lastLuckyNumber + 1, 
                name, 
                docType,
                docNumber,
                registrationTimestamp: new Date().toISOString()
            };
            
            participantsRef.child(firebaseId).set(newParticipant);
            document.getElementById('lucky-number-display').textContent = newParticipant.luckyNumber;
            luckyNumberModal.style.display = 'flex';
            form.reset();
            docTypeSelect.dispatchEvent(new Event('change'));
            fullNameInput.focus();
        });
        
        const closeModal = () => modals.forEach(m => m.style.display = 'none');
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.onclick = closeModal);

        bulkAddBtn.addEventListener('click', () => { bulkAddModal.style.display = 'flex'; menuPanel.classList.remove('open'); });

        processBulkListBtn.addEventListener('click', () => {
            const parseTextToNameAndDoc = (text) => {
                let name = text, docNumber = '', docType = '';
                const numbers = text.match(/\b\d{8,11}\b/);
                if (numbers && numbers[0]) {
                    const num = numbers[0].replace(/\D/g, '');
                    name = text.replace(num, '').replace(/\s+/g, ' ').trim();
                    docNumber = num;
                    if (num.length === 11) docType = 'CPF';
                    else if (num.length === 9) docType = 'RG';
                    else if (num.length === 8) docType = 'Nascimento';
                }
                return { name, docType, docNumber };
            };

            const lines = bulkPasteArea.value.trim().split('\n');
            let lastLuckyNumber = participants.length > 0 ? Math.max(...participants.map(p => p.luckyNumber)) : 0;
            const updates = {};
            const addedDocs = new Set(participants.filter(p => p.docType !== 'Nascimento').map(p => `${p.docType}_${p.docNumber}`));
            let newCount = 0, skippedCount = 0;

            lines.forEach(line => {
                if (!line.trim()) return;
                const { name, docType, docNumber } = parseTextToNameAndDoc(line);
                if (!name || !docType || !docNumber) { skippedCount++; return; }

                const docKey = `${docType}_${docNumber}`;
                if (docType !== 'Nascimento' && (participants.some(p => p.id === docKey) || addedDocs.has(docKey))) { skippedCount++; return; }
                
                addedDocs.add(docKey);
                lastLuckyNumber++;
                newCount++;

                let firebaseId = (docType !== 'Nascimento') ? docKey : `Nasc_${docNumber}_${Date.now()}_${newCount}`;
                updates[firebaseId] = { id: firebaseId, luckyNumber: lastLuckyNumber, name, docType, docNumber, registrationTimestamp: new Date().toISOString() };
            });
            
            if (Object.keys(updates).length > 0) participantsRef.update(updates);
            alert(`${newCount} adicionado(s).\n${skippedCount} ignorado(s) (inv√°lidos ou duplicados).`);
            closeModal();
            bulkPasteArea.value = '';
        });

        menuToggle.addEventListener('click', () => menuPanel.classList.toggle('open'));
        document.addEventListener('click', e => { if (!menuPanel.contains(e.target) && !menuToggle.contains(e.target)) menuPanel.classList.remove('open'); });

        const openEditModal = (idToEdit) => {
            const p = participants.find(p => p.id === idToEdit);
            if (!p) return;
            document.getElementById('edit-id').value = p.id;
            document.getElementById('edit-fullName').value = p.name;
            document.getElementById('edit-doc').value = `${p.docType}: ${p.docNumber}`;
            editModal.style.display = 'flex';
        };

        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const idToEdit = document.getElementById('edit-id').value;
            const newName = document.getElementById('edit-fullName').value.trim();
            if (newName) {
                participantsRef.child(idToEdit).child('name').set(newName);
                closeModal();
            } else {
                alert('O nome n√£o pode ser vazio.');
            }
        });
        
        toggleListBtn.addEventListener('click', () => {
            const isHidden = participantListSection.style.display !== 'block';
            participantListSection.style.display = isHidden ? 'block' : 'none';
            toggleListBtn.textContent = isHidden ? 'Ocultar Lista' : 'Visualizar Lista';
            if (isHidden) renderList();
        });

        drawBtn.addEventListener('click', () => {
            drawOptionsModal.style.display = 'flex';
            menuPanel.classList.remove('open');
        });

        drawOptionsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const excludeWinners = document.getElementById('exclude-winners-checkbox').checked;

            let eligible = [...participants];
            if (excludeWinners) {
                const winnerLuckyNumbers = new Set(winners.map(w => w.luckyNumber));
                eligible = eligible.filter(p => !winnerLuckyNumbers.has(p.luckyNumber));
            }
            if (eligible.length === 0) return alert('Nenhum participante eleg√≠vel para o sorteio.');

            const winner = eligible[Math.floor(Math.random() * eligible.length)];
            
            const winnerRecord = { ...winner, drawTimestamp: new Date().toISOString() };
            winnersRef.push(winnerRecord);

            drawOptionsModal.style.display = 'none';

            // **MODIFICA√á√ÉO AQUI**
            const winnerDetailsEl = document.getElementById('winner-details');
            const regDate = new Date(winner.registrationTimestamp);
            const manausDateTime = new Intl.DateTimeFormat('pt-BR', {
                timeZone: 'America/Manaus',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(regDate);

            document.getElementById('winner-name').textContent = `#${winner.luckyNumber} - ${winner.name}`;
            winnerDetailsEl.innerHTML = `
                ${winner.docType}: ${winner.docNumber}<br>
                <span style="font-size: 0.85em; color: #555;">Cadastrado em: ${manausDateTime}</span>
            `;
            
            winnerModal.style.display = 'flex';
        });
        
        viewWinnersBtn.addEventListener('click', () => {
            const container = document.getElementById('winners-list-container');
            container.innerHTML = winners.length === 0 ? '<p>Nenhum sorteio realizado.</p>' : '';
            
            winners
                .sort((a,b) => new Date(b.drawTimestamp) - new Date(a.drawTimestamp))
                .forEach(w => {
                    const drawDate = new Date(w.drawTimestamp);
                    const manausTime = new Intl.DateTimeFormat('pt-BR', {
                        timeZone: 'America/Manaus',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    }).format(drawDate);

                    container.innerHTML += `<div class="participant-item">
                        <div class="participant-info">
                            <div class="name">#${w.luckyNumber} - ${w.name}</div>
                            <div class="details">${w.docType}: ${w.docNumber}</div>
                            <div class="details" style="font-weight: bold;">Sorteado √†s: ${manausTime}</div>
                        </div>
                    </div>`;
            });
            winnersListModal.style.display = 'flex';
            menuPanel.classList.remove('open');
        });

        document.getElementById('delete-all-btn').addEventListener('click', () => { if (confirm('APAGAR LISTA DE PARTICIPANTES?')) { participantsRef.set(null); } menuPanel.classList.remove('open'); });
        document.getElementById('reset-all-btn').addEventListener('click', () => { if (confirm('RESETAR TUDO? (Apaga participantes E sorteados)')) { database.ref().set(null); } menuPanel.classList.remove('open'); });
        
        // Fun√ß√µes de importa√ß√£o e download
        const otherFunctions = () => {
             document.getElementById('import-file-menu').addEventListener('change', (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (Array.isArray(importedData) && confirm(`Importar ${importedData.length} participantes? A lista atual ser√° substitu√≠da.`)) {
                            const dataToUpload = {};
                            importedData.forEach(p => { if(p.id) dataToUpload[p.id] = p; });
                            participantsRef.set(dataToUpload);
                        }
                    } catch (error) { alert('Arquivo JSON inv√°lido.'); }
                };
                reader.readAsText(file);
                menuPanel.classList.remove('open');
            });
            const createDownloadLink = (data, type) => URL.createObjectURL(new Blob([data], { type }));
            document.getElementById('download-json-btn').addEventListener('click', (e) => {
                e.target.href = createDownloadLink(JSON.stringify(participants, null, 2), 'application/json');
                e.target.download = 'participantes_sorteio.json';
            });
            document.getElementById('download-csv-btn').addEventListener('click', (e) => {
                let csvContent = 'NumeroSorte,Nome,TipoDocumento,Documento,DataRegistro\n';
                participants.forEach(p => {
                    const regDate = p.registrationTimestamp ? new Date(p.registrationTimestamp).toLocaleString('pt-BR', { timeZone: 'America/Manaus' }) : 'N/A';
                    csvContent += `${p.luckyNumber},"${p.name.replace(/"/g, '""')}",${p.docType},${p.docNumber},"${regDate}"\n`;
                });
                e.target.href = createDownloadLink(csvContent, 'text/csv;charset=utf-8;');
                e.target.download = 'participantes_sorteio.csv';
            });
            document.getElementById('parse-btn').addEventListener('click', () => {
                 const parseTextToNameAndDoc = (text) => {
                    let name = text, docNumber = '', docType = '';
                    const numbers = text.match(/\b\d{8,11}\b/);
                    if (numbers && numbers[0]) {
                        const num = numbers[0].replace(/\D/g, '');
                        name = text.replace(num, '').replace(/\s+/g, ' ').trim();
                        docNumber = num;
                        if (num.length === 11) docType = 'CPF';
                        else if (num.length === 9) docType = 'RG';
                        else if (num.length === 8) docType = 'Nascimento';
                    }
                    return { name, docType, docNumber };
                };
                const { name, docType, docNumber } = parseTextToNameAndDoc(document.getElementById('paste-area').value);
                if (name) fullNameInput.value = name;
                if (docType) docTypeSelect.value = docType;
                if (docNumber) docNumberInput.value = docNumber;
                docTypeSelect.dispatchEvent(new Event('change'));
                document.getElementById('paste-area').value = '';
            });
        };
        otherFunctions();

        updateButtonStates();
    });
    </script>
</body>
</html>
